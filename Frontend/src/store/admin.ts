import axios from '@/plugins/axios'
import proxyUrls from '@/constants/proxyUrls'
type AnyObj = Record<string, unknown>
type CommitFn = (mutation: string, payload?: unknown) => void
type ActionCtx = { commit: CommitFn; state?: AnyObj; dispatch?: (action: string, payload?: unknown) => Promise<unknown> }
interface State { products: AnyObj[]; stores: AnyObj[]; categories: AnyObj[]; tariffCategories: AnyObj[]; pagination: { page: number; total: number; limit: number }; sortBy: string }
export default { namespaced: true, state: { products: [], stores: [], categories: [], tariffCategories: [], pagination: { page: 1, total: 0, limit: 10 }, sortBy: '-active' } as State, actions: { async getReferenceData({ commit }: ActionCtx) { try { const { data } = await axios.get(proxyUrls.refData); if (data) commit('setRefData', data) } catch (err) { console.log('Error', err) } }, async getAllProducts({ commit, state }: ActionCtx, filters: AnyObj | undefined) { try { const params = { limit: (state?.pagination as unknown as AnyObj)?.limit, page: (state?.pagination as unknown as AnyObj)?.page, ...(filters || {}) }; const { data } = await axios.get(proxyUrls.listCatalog, { params }); if (data) { commit('setProducts', data.rows); commit('setPagination', { page: (state?.pagination as unknown as AnyObj)?.page, limit: (state?.pagination as unknown as AnyObj)?.limit, total: data.count }) } } catch (err) { throw err } }, async addProduct({ dispatch }: ActionCtx, payload: FormData) { try { await axios.post(proxyUrls.addProduct, payload, { headers: { 'Content-Type': 'multipart/form-data' } }); dispatch?.('getAllProducts') } catch (err) { console.log('Error', err); throw err } }, async editProduct({ dispatch }: ActionCtx, product: AnyObj) { try { const id = (product as unknown as AnyObj).id as string; await axios.put(`${proxyUrls.updateProduct}/${id}`, product); dispatch?.('getAllProducts') } catch (err) { console.log('Error', err); throw err } }, async deleteProduct({ dispatch }: ActionCtx, id: string) { try { await axios.delete(`${proxyUrls.deleteProduct}/${id}`); dispatch?.('getAllProducts') } catch (err) { console.log('Error', err) } } }, mutations: { setProducts(state: State, payload: AnyObj[]) { state.products = payload }, setPagination(state: State, payload: AnyObj) { state.pagination = payload as unknown as { page: number; limit: number; total: number } }, setRefData(state: State, payload: AnyObj) { const p = payload as unknown as AnyObj; state.stores = (p.stores as AnyObj[] | undefined) || []; state.categories = (p.categories as AnyObj[] | undefined) || []; state.tariffCategories = (p.tariffs as AnyObj[] | undefined) || [] } }, getters: { allProducts: (state: State) => state.products, allStateData: (state: State) => state, tariffCategories: (state: State) => state.tariffCategories, pagination: (state: State) => state.pagination } }