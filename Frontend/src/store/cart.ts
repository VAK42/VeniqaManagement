import axios from '@/plugins/axios'
import proxyUrls from '@/constants/proxyUrls'
import _ from 'lodash'
type AnyObj = Record<string, unknown>
type CommitFn = (mutation: string, payload?: unknown) => void
type ActionCtx = { commit: CommitFn; state: State }
interface State { cart: AnyObj[] }
export default { namespaced: true, state: { cart: [] } as State, actions: { async addToTheCart({ commit }: ActionCtx, payload: AnyObj) { try { const id = (payload as unknown as AnyObj).id as string; const { data } = await axios.post(proxyUrls.addToCart, { productId: id }); commit('setCart', data) } catch (err) { console.log('Error Occurred', err) } }, async getCart({ commit }: ActionCtx) { try { const { data } = await axios.get(proxyUrls.getCart); commit('setCart', data) } catch { throw new Error('Failed to get cart') } }, async deleteOrders({ commit }: ActionCtx, products: AnyObj[]) { const productIds = _.map(products as AnyObj[], 'id'); try { const { data } = await axios.post(proxyUrls.deleteCart, { productIds }); if (data) { commit('deleteProduct', productIds) } } catch { throw new Error('Failed to delete cart items') } }, async updateOrders({ state, commit }: ActionCtx) { const orders = (state.cart || []).map((c: AnyObj) => ({ productId: (c as AnyObj).id, counts: (c as AnyObj).counts })); try { const { data } = await axios.post(proxyUrls.updateCart, orders); commit('setCart', data) } catch { console.log('Could Not Update Order') } } }, mutations: { setCart(state: State, allProducts: AnyObj[]) { state.cart = []; const transformed: AnyObj[] = []; allProducts.forEach((pr: AnyObj) => { const temp = (pr as AnyObj).product as AnyObj; (temp as AnyObj).counts = (pr as AnyObj).counts; transformed.push(temp) }); state.cart.push(...transformed) }, deleteProduct(state: State, productIds: string[]) { _.remove(state.cart as AnyObj[], (c: AnyObj) => productIds.indexOf((c as AnyObj).id as string) >= 0); state.cart = [...state.cart] } }, getters: { getCart: (state: State) => state.cart } }