import axios from '@/plugins/axios'
import proxyUrls from '@/constants/proxyUrls'
type AnyObj = Record<string, unknown>
type CommitFn = (mutation: string, payload?: unknown) => void
type ActionCtx = { commit: CommitFn; state?: AnyObj }
interface State { orders: AnyObj[]; orderStatus: string; pagination: { page: number; total: number; limit: number }; openOrder: AnyObj | null }
export default { namespaced: true, state: { orders: [], orderStatus: '', pagination: { page: 1, total: 0, limit: 10 }, openOrder: null } as State, mutations: { setOpenOrder(state: State, order: AnyObj) { state.openOrder = order }, setOrderStatus(state: State, val: string) { state.orderStatus = val }, setOrderDetails(state: State, payload: AnyObj) { const p = payload as AnyObj; if (Array.isArray(p.rows)) state.orders = p.rows as AnyObj[]; state.pagination = { total: (p.count as number) || 0, limit: (p.limit as number) || 10, page: (p.page as number) || 1 } } }, actions: { async getOrdersByStatus({ commit, state }: ActionCtx, status: string) { try { const limit = (state?.pagination as AnyObj)?.limit as number | undefined; const page = (state?.pagination as AnyObj)?.page as number | undefined; const url = (proxyUrls.getOrders as string) || '/orders'; const { data } = await axios.get(url, { params: { status, limit, page } }); commit('setOrderDetails', data); commit('setOrderStatus', status) } catch (error) { throw error } }, async openOrderDetail({ commit }: ActionCtx, order: AnyObj) { const id = (order as AnyObj).id as string | undefined; if (!id) return false; try { const url = (proxyUrls.getOrderById as string) || '/orders'; const { data } = await axios.get(`${url}/${id}`); if (data) { commit('setOpenOrder', data); return true } return false } catch (error) { throw error } }, async confirmOrder({ commit, state }: ActionCtx) { const open = (state as AnyObj).openOrder as AnyObj | null; if (!open) return false; const oid = open.id as string | undefined; if (!oid) return false; try { const { data } = await axios.put(`${proxyUrls.updateOrderStatus}/${oid}/status`, { status: 'CONFIRMED' }); commit('setOpenOrder', data); return true } catch (error) { throw error } }, async fulfillItem({ commit }: ActionCtx, payload: AnyObj) { const fulfillment = (payload as AnyObj).fulfillmentDetail as unknown; try { const url = (proxyUrls.fulfillOrder as string) || '/orders/fulfill'; const { data } = await axios.post(url, fulfillment); commit('setOpenOrder', data); return true } catch (error) { throw error } } }, getters: { orderStatus: (state: State) => state.orderStatus, orders: (state: State) => state.orders, openOrder: (state: State) => state.openOrder, pagination: (state: State) => state.pagination } }