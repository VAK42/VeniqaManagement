import proxyUrls from '@/constants/proxyUrls'
import axios from '@/plugins/axios'
type AnyObj = Record<string, unknown>
type CommitFn = (mutation: string, payload?: unknown) => void
type ActionCtx = { commit: CommitFn }
interface State { email: string; name: string; isSessionActive: boolean; permissions: string[] }
export default { namespaced: true, state: { email: '', name: '', isSessionActive: false, permissions: [] as string[] } as State, actions: { async login({ commit }: ActionCtx, payload: AnyObj | null) { if (!payload) return null; try { const { data } = await axios.post(proxyUrls.loginUrl, payload); if (data) { const d = data as unknown as AnyObj; commit('setEmail', d.email as string); commit('setName', d.name as string); commit('setSessionActive', true); commit('setPermissions', (d.permissions as unknown as string[]) || []); const token = (d.token as string) || 'dummy-token-for-auth-guard'; localStorage.setItem('accessToken', token); localStorage.setItem('permissions', JSON.stringify((d.permissions as unknown as string[]) || [])) } return data } catch (err) { throw err } }, async initiateAppSession({ commit }: ActionCtx) { const token = localStorage.getItem('accessToken'); if (token) { commit('setEmail', localStorage.getItem('email')); commit('setName', localStorage.getItem('name')); try { const perms = JSON.parse(localStorage.getItem('permissions') || '[]'); commit('setPermissions', perms) } catch { commit('setPermissions', []) } commit('setSessionActive', true) } else { commit('setSessionActive', false) } }, async logout({ commit }: ActionCtx) { commit('logout'); return true } }, mutations: { setPermissions(state: State, payload: string[]) { state.permissions = payload }, setEmail(state: State, email: string) { state.email = email; localStorage.setItem('email', email) }, setName(state: State, name: string) { state.name = name; localStorage.setItem('name', name) }, setSessionActive(state: State, val: boolean) { state.isSessionActive = val; if (!val) { localStorage.removeItem('email'); localStorage.removeItem('name'); localStorage.removeItem('permissions'); localStorage.removeItem('accessToken') } }, logout(state: State) { state.isSessionActive = false; state.permissions = []; state.name = ''; state.email = ''; localStorage.clear() } }, getters: { isSessionActive: (state: State) => state.isSessionActive, permissions: (state: State) => state.permissions, getName: (state: State) => state.name } }